defaultNamespace: cattle-monitoring-system
helm:
  releaseName: rancher-monitoring
  repo: https://charts.rancher.io
  chart: rancher-monitoring
  version: 100.0.0+up16.6.0
  values:
    rkeEtcd:
      enabled: true
    rkeProxy:
      enabled: true
    rkeScheduler:
      enabled: true
    rkeControllerManager:
      enabled: true
    prometheus:
      prometheusSpec:
        ruleSelector:
          matchLabels:
            ruleType: insaas-alert-rules
        resources:
          limits:
            memory: 3500Mi
          requests:
            memory: 3500Mi
    alertmanager:
      config:
        global:
          resolve_timeout: 5m
        route:
          receiver: "insaas-infra-receiver"
          group_by:
            - alertname
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 2h
          routes:
            - receiver: "insaas-receiver"
              match_re:
                namespace: "claims.*|pricing.*|shared.*|platform.*|payments.*|policy.*"
              continue: false
            - receiver: "insaas-infra-receiver"
              continue: false
        templates:
          - /etc/alertmanager/config/*.tmpl

      templateFiles:
        010_slack_notification.tmpl: |-
          {{ define "__title" }}Alert {{ .CommonLabels.alertname}} has been triggered in EW2 [{{ len .Alerts.Firing }}]{{ end }}
          {{ define "__slacktext" }}
          <{{ .CommonAnnotations.troubleshooting }}|*Troubleshooting Guide* :spiral_note_pad:>
          {{ range .Alerts.Firing }}
          :warning: {{ "*Alert Firing*"}}
          {{ "*Description:*" }} {{ .Annotations.description }}
          {{ "*Status:*"}} Firing :fire:
          {{ "*Since:*"}} {{ .StartsAt.Format "15:04:05 2006 Jan 02 UTC" }}
          {{ end }}
          {{ range .Alerts.Resolved }}
          :warning: {{ "*Alert Resolved*"}}
          {{ "*Description:*" }} {{ .Annotations.description }}
          {{ "*Status:*"}} Resolved :white_check_mark:
          {{ "*Since:*"}} {{ .StartsAt.Format "15:04:05 2006 Jan 02 UTC" }}
          {{ "*Ended:*"}} {{ .EndsAt.Format "15:04:05 2006 Jan 02 UTC" }}
          {{ end }}
          {{ end }}
          {{ define "slack.default.text" }}{{ template "__slacktext" . }}{{ end }}
          {{ define "slack.default.title" }}{{ template "__title" . }}{{ end }}
          {{ define "slack.default.pretext" }}New alerts triggered from Alertmanager{{ end }}

diff:
  comparePatches:
    - apiVersion: admissionregistration.k8s.io/v1beta1
      kind: MutatingWebhookConfiguration
      name: rancher-monitoring-admission
      jsonPointers:
        - /webhooks/0/failurePolicy
    - apiVersion: admissionregistration.k8s.io/v1beta1
      kind: ValidatingWebhookConfiguration
      name: rancher-monitoring-admission
      jsonPointers:
        - /webhooks/0/failurePolicy
    - apiVersion: policy/v1beta1
      kind: PodSecurityPolicy
      operations:
        - {"op":"remove", "path":"/spec/hostIPC"}
        - {"op":"remove", "path":"/spec/hostNetwork"}
        - {"op":"remove", "path":"/spec/hostPID"}
        - {"op":"remove", "path":"/spec/privileged"}
        - {"op":"remove", "path":"/spec/readOnlyRootFilesystem"}
    - apiVersion: apps/v1
      kind: Deployment
      name: rancher-monitoring-grafana
      namespace: cattle-monitoring-system
      operations:
        - {"op":"remove", "path":"/spec/template/spec/containers/0/env/0/value"}
    - apiVersion: apps/v1
      kind: Deployment
      operations:
        - {"op":"remove", "path":"/spec/template/spec/hostNetwork"}
        - {"op":"remove", "path":"/spec/template/spec/nodeSelector"}
        - {"op":"remove", "path":"/spec/template/spec/priorityClassName"}
        - {"op":"remove", "path":"/spec/template/spec/tolerations"}
    - apiVersion: v1
      kind: ServiceAccount
      operations:
        - {"op":"remove", "path":"/imagePullSecrets"}

targetCustomizations:
  - name: box
    clusterSelector:
      matchLabels:
        management.cattle.io/cluster-display-name: insaas-box
    helm:
      values:
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-box'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-box'

  - name: dev
    clusterSelector:
      matchLabels:
        management.cattle.io/cluster-display-name: insaas-dev
    helm:
      values:
        rkeEtcd:
          enabled: true
        rkeProxy:
          enabled: true
        rkeScheduler:
          enabled: true
        rkeControllerManager:
          enabled: true
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-dev'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-dev'

  - name: sit
    clusterSelector:
      matchLabels:
        management.cattle.io/cluster-display-name: insaas-sit
    helm:
      values:
        rkeEtcd:
          enabled: true
        rkeProxy:
          enabled: true
        rkeScheduler:
          enabled: true
        rkeControllerManager:
          enabled: true
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-sit'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-sit'

  - name: stg
    clusterSelector:
      matchLabels:
        management.cattle.io/cluster-display-name: insaas-stg
    helm:
      values:
        rkeEtcd:
          enabled: true
        rkeProxy:
          enabled: true
        rkeScheduler:
          enabled: true
        rkeControllerManager:
          enabled: true
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-stg'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-stg'

  - name: preview
    clusterSelector:
      matchLabels:
        vpc: preview
    helm:
      values:
        rkeEtcd:
          enabled: true
        rkeProxy:
          enabled: true
        rkeScheduler:
          enabled: true
        rkeControllerManager:
          enabled: true
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-preview'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-preview'

  - name: prod
    clusterSelector:
      matchLabels:
        vpc: prod
    helm:
      values:
        rkeEtcd:
          enabled: true
        rkeProxy:
          enabled: true
        rkeScheduler:
          enabled: true
        rkeControllerManager:
          enabled: true
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-prod'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-prod'

  - name: box-ew1
    clusterSelector:
      matchLabels:
        management.cattle.io/cluster-display-name: insaas-box-ew1
    helm:
      values:
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-box'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-box'
          templateFiles:
            090_insaas_regional_config.tmpl: |-
              {{ define "__title" }}Alert {{ .CommonLabels.alertname}} has been triggered in EW1 [{{ len .Alerts.Firing }}]{{ end }}

  - name: dev-ew1
    clusterSelector:
      matchLabels:
        management.cattle.io/cluster-display-name: insaas-dev-ew1
    helm:
      values:
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-dev'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-dev'
          templateFiles:
            090_insaas_regional_config.tmpl: |-
              {{ define "__title" }}Alert {{ .CommonLabels.alertname}} has been triggered in EW1 [{{ len .Alerts.Firing }}]{{ end }}

  - name: sit-ew1
    clusterSelector:
      matchLabels:
        management.cattle.io/cluster-display-name: insaas-sit-ew1
    helm:
      values:
        rkeEtcd:
          enabled: true
        rkeProxy:
          enabled: true
        rkeScheduler:
          enabled: true
        rkeControllerManager:
          enabled: true
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-sit'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-sit'
          templateFiles:
            090_insaas_regional_config.tmpl: |-
              {{ define "__title" }}Alert {{ .CommonLabels.alertname}} has been triggered in EW1 [{{ len .Alerts.Firing }}]{{ end }}

  - name: stg-ew1
    clusterSelector:
      matchLabels:
        management.cattle.io/cluster-display-name: insaas-stg-ew1
    helm:
      values:
        rkeEtcd:
          enabled: true
        rkeProxy:
          enabled: true
        rkeScheduler:
          enabled: true
        rkeControllerManager:
          enabled: true
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-stg'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-stg'
          templateFiles:
            090_insaas_regional_config.tmpl: |-
              {{ define "__title" }}Alert {{ .CommonLabels.alertname}} has been triggered in EW1 [{{ len .Alerts.Firing }}]{{ end }}

  - name: preview-ew1
    clusterSelector:
      matchLabels:
        vpc: preview-ew1
    helm:
      values:
        rkeEtcd:
          enabled: true
        rkeProxy:
          enabled: true
        rkeScheduler:
          enabled: true
        rkeControllerManager:
          enabled: true
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-preview'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-preview'
          templateFiles:
            090_insaas_regional_config.tmpl: |-
              {{ define "__title" }}Alert {{ .CommonLabels.alertname}} has been triggered in EW1 [{{ len .Alerts.Firing }}]{{ end }}

  - name: prod-ew1
    clusterSelector:
      matchLabels:
        vpc: prod-ew1
    helm:
      values:
        rkeEtcd:
          enabled: true
        rkeProxy:
          enabled: true
        rkeScheduler:
          enabled: true
        rkeControllerManager:
          enabled: true
        alertmanager:
          config:
            receivers:
              - name: "insaas-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-prod'
              - name: "insaas-infra-receiver"
                slack_configs:
                  - send_resolved: true
                    api_url: https://hooks.slack.com/services/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
                    channel: '#alert-insaas-infra-prod'
          templateFiles:
            090_insaas_regional_config.tmpl: |-
              {{ define "__title" }}Alert {{ .CommonLabels.alertname}} has been triggered in EW1 [{{ len .Alerts.Firing }}]{{ end }}

  - name: rke2
    helm:
      values:
        rke2Etcd:
          enabled: true
        rke2Proxy:
          enabled: true
        rke2Scheduler:
          enabled: true
        rke2ControllerManager:
          enabled: true
    clusterSelector:
      matchLabels:
        provisioner: rke2
